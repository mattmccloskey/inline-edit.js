function $InlineEdit(t){return $(t).retrieve("InlineEdit")}var InlineEdit=new Class({Implements:[Options,Events],options:{enter_on:"click",leave_on_enter:!0,leave_on_blur:!0,leave_on_esc:!0,focus_on_enter:!0,select_on_enter:!0,update_url:"",field_title:"",field_type:"default",field_options:{type:"text"},min_width:50,formatValue:function(t){return t},events:{}},initialize:function(t,e){return this.setOptions(e),this.el=$(t),this.el?(this.el.setStyles({cursor:"default"}).store("InlineEdit:init_value",this.el.get("text")),this.el.retrieve("InlineEdit")?this.el.retrieve("InlineEdit"):(this.input=!1,this.last_value=this.el.get("text"),this.new_value=this.last_value,this.active=!0,this.editing=!1,this.binds={enter:this.enter_edit.bind(this)},this.options.enter_on&&this.el.addEvent(this.options.enter_on,function(t){this.binds.enter(t)}.bind(this)),this.addEvents(this.options.events),void this.el.store("InlineEdit",this))):!1},enterEdit:function(){return this.enter_edit()},leaveEdit:function(){return this.leave_edit()},enter_edit:function(t){if(!this.editing){if(!this.active)return!1;t&&t.preventDefault(),this.editing=!0,this.last_html=this.el.get("html"),this.last_value=this.el.get("html").replace(/<br[\/]?>/gi,"\n"),"default"==this.options.field_type&&(this.options.field_type=["div","p"].contains(this.el.get("tag"))&&"block"==this.el.getStyle("display")?"textarea":"input"),this.sizer=new Element("span",{html:this.last_html,styles:{display:"inline-block",position:"absolute",opacity:0,"z-index":1}}).inject(this.el,"after").position({relativeTo:this.el,edge:"topLeft",position:"topLeft"}).copyStyles(this.el),"textarea"==this.options.field_type&&(this.sizer.setStyles({width:this.el.getSize().x,height:"auto"}),this.options.leave_on_blur=!0),this.input=new Element(this.options.field_type,{name:"title",value:this.last_value,"class":"inlineedit-input",styles:{"z-index":2,opacity:0,resize:"none"},events:{blur:function(){this.options.leave_on_blur&&this.leave_edit()}.bind(this),keydown:function(t){this.fireEvent("keydown",t),this.el.fireEvent("keydown",t),this.options.tab_to&&"tab"==t.key&&(t.stop(),this.leave_edit(),this.options.tab_to.enterEdit()),this.options.leave_on_esc&&"esc"==t.key&&this.leave_edit(),this.match_size()}.bind(this),keypress:function(t){(this.options.leave_on_esc&&"esc"==t.key||this.options.leave_on_enter&&"enter"==t.key&&"textarea"!=this.options.field_type)&&this.leave_edit(),this.match_size()}.bind(this),keyup:function(){var t=this.input.get("value").replace(/\n/gi,"<br/>");"<br/>"==t.substr(-5)&&(t+="<br/>"),this.sizer.set("html",t),this.el.set("html",t),this.match_size()}.bind(this)}}).inject(this.el,"after");var e=this.input.getStyle("padding");this.input.copyStyles(this.el),this.input.setStyle("padding",e),this.input.set(this.options.field_options);var i={x:-(e.split(" ")[3].toInt()+this.input.getStyle("border-left-width").toInt()),y:-(e.split(" ")[0].toInt()+this.input.getStyle("border-top-width").toInt())};"input"==this.options.field_type&&(i.x-=1,i.y-=2),this.input.position({relativeTo:this.sizer,edge:"topLeft",position:"topLeft",offset:i});var s=0,n=Fx.Transitions.Cubic.easeOut;this.input.set("tween",{duration:s,transition:n}).tween("opacity",[0,1]),this.el.set("tween",{duration:s,transition:n}).tween("opacity",0),this.options.focus_on_enter&&(this.options.select_on_enter?this.input.select.delay(s,this.input):this.input.setCursor(this.input.get("value").length)),this.match_size({duration:0}),this.fireEvent("enterEdit",[this.input]),this.el.fireEvent("enterEdit",[this.input])}},leave_edit:function(){if(!this.editing)return!0;if(this.editing=!1,this.new_value=this.input.get("value"),this.options.formatValue&&(this.new_value=this.options.formatValue(this.new_value,this.last_value,this)),""==this.new_value&&(this.new_value=this.last_value),this.input.destroy(),this.sizer.destroy(),this.el.setStyles({opacity:1}),this.el.set("html",this.new_value.replace(/\n/gi,"<br/>")),this.fireEvent("leaveEdit",[this.new_value,this.last_value,this.new_value!=this.last_value]),this.el.fireEvent("leaveEdit",[this.new_value,this.last_value,this.new_value!=this.last_value]),this.new_value!=this.last_value&&(this.fireEvent("onChange",[this.new_value,this.old_value]),this.el.fireEvent("onChange",[this.new_value,this.old_value]),this.options.update_url)){var t={};t[this.options.field_title]=this.new_value;{new Request.JSON({url:this.options.update_url,method:"post"}).addEvent("success",function(t){"ok"==t.status?(this.el.set("html",(t.data[this.options.field_title]||this.new_value).replace("\n","\n<br/>")),this.fireEvent("onSave",[this.el,t.data]),this.el.fireEvent("onSave",[this.el,t.data])):alert(t.msg)}.bind(this)).post(t)}}},match_size:function(t){"input"==this.options.field_type?this.input.setStyles({width:Math.max(this.options.min_width,this.sizer.getSize().x+this.sizer.getStyle("font-size").toInt())}):"textarea"==this.options.field_type&&this.input.set("morph",Object.merge({duration:200,transition:Fx.Transitions.Cubic.easeOut},t)).morph({width:this.sizer.getSize().x+2*(this.input.getStyle("padding").split(" ")[3]||this.input.getStyle("padding").split(" ")[1]||0).toInt(),height:Math.max((this.sizer.getStyle("line-height").toInt()||this.sizer.getStyle("font-size").toInt())+5,this.sizer.getSize().y+2*(this.input.getStyle("padding").split(" ")[0]||0).toInt())})},suspend:function(){this.active=!1},resume:function(){this.active=!0}});Element.implement({enterEdit:function(t){return this.retrieve("InlineEdit")||this.store("inlineedit_onthefly",!0),t=Object.merge({enter_on:!1,select_on_enter:!1},t||{}),new InlineEdit(this,t).enter_edit(),this},leaveEdit:function(){var t=this.retrieve("InlineEdit");return t&&t.leave_edit(),this.retrievs("inlineedit_onthefly")&&(delete t,this.store("InlineEdit",!1)),this},copyStyles:function(t){return this.setStyles({padding:t.getStyle("padding"),"font-weight":t.getStyle("font-weight"),"font-style":t.getStyle("font-style"),"font-size":t.getStyle("font-size"),"line-height":t.getStyle("line-height")}),this.style.fontFamily=t.getStyle("font-family"),this},setCursor:function(t){if(this.createTextRange){var e=this.createTextRange();return e.collapse(!0),e.moveEnd(t),e.moveStart(t),e.select(),!0}return this.setSelectionRange?(this.setSelectionRange(t,t),!0):!1}});